<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Adobe 25</title>
    <link rel="icon" type="image/png" href="assets/Adobe_25.png" />
    <style>
      body {
        font-family: sans-serif;
        text-align: center;
        background: #f8f8f8;
        margin: 0;
      }
      canvas {
        border: 2px solid #555;
        background: #f0f0f0;
        border-radius: 8px;
        margin-top: 10px;
      }
      h1 {
        margin-bottom: 0;
      }
    </style>
  </head>
  <body>
    <h1>
        <img src="assets/Adobe_25.png" alt="logo" style="width:40px; height:40px; vertical-align:middle; margin-right:10px;">
        "Adobe 25" Image Editor
    </h1>
    <p>Drag = move image + anchor | Drag anchor = move anchor | Scroll = scale | Shift+R = rotate mode | Space = reset anchor</p>
    <input type="file" id="fileInput" accept="image/*" />
    <canvas id="canvas" width="1400" height="800"></canvas>

    <script>
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      const fileInput = document.getElementById("fileInput");

      let img = null;
      let isDragging = false;
      let isMovingAnchor = false;
      let isRotating = false;
      let lastMouse = { x: 0, y: 0 };

      const imageState = {
        x: 700,
        y: 400,
        scale: 1,
        angle: 0,
        anchorX: 0,
        anchorY: 0,
      };

      const ANCHOR_RADIUS = 10;

      fileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          img = new Image();
          img.onload = draw;
          img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
      });

      // Drawing
      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (!img) return;

        // Draw image
        ctx.save();
        ctx.translate(imageState.x, imageState.y);
        ctx.rotate(imageState.angle);
        ctx.scale(imageState.scale, imageState.scale);
        ctx.drawImage(
          img,
          -img.width / 2,
          -img.height / 2
        );
        ctx.restore();

        // Draw anchor
        const a = toScreenCoords(imageState.anchorX, imageState.anchorY);
        ctx.beginPath();
        ctx.arc(a.x, a.y, ANCHOR_RADIUS, 0, Math.PI * 2);
        ctx.fillStyle = "red";
        ctx.strokeStyle = "black";
        ctx.lineWidth = 2;
        ctx.fill();
        ctx.stroke();
      }

      // Math
      function toScreenCoords(ax, ay) {
        const cos = Math.cos(imageState.angle);
        const sin = Math.sin(imageState.angle);
        return {
          x:
            imageState.x +
            (ax * imageState.scale * cos - ay * imageState.scale * sin),
          y:
            imageState.y +
            (ax * imageState.scale * sin + ay * imageState.scale * cos),
        };
      }

      function fromScreenCoords(sx, sy) {
        const dx = sx - imageState.x;
        const dy = sy - imageState.y;
        const cos = Math.cos(-imageState.angle);
        const sin = Math.sin(-imageState.angle);
        return {
          x: (dx * cos - dy * sin) / imageState.scale,
          y: (dx * sin + dy * cos) / imageState.scale,
        };
      }

      // Mouse Events
      canvas.addEventListener("mousedown", (e) => {
        if (!img) return;
        lastMouse = { x: e.offsetX, y: e.offsetY };
        const anchor = toScreenCoords(imageState.anchorX, imageState.anchorY);
        const dx = e.offsetX - anchor.x;
        const dy = e.offsetY - anchor.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < ANCHOR_RADIUS + 5) {
          isMovingAnchor = true;
        } else {
          isDragging = true;
        }
      });

      canvas.addEventListener("mouseup", () => {
        isDragging = false;
        isMovingAnchor = false;
      });

      canvas.addEventListener("mousemove", (e) => {
        if (!img) return;
        const mx = e.offsetX;
        const my = e.offsetY;
        const dx = mx - lastMouse.x;
        const dy = my - lastMouse.y;

        if (isDragging && !isRotating) {
          // Move image
          imageState.x += dx;
          imageState.y += dy;
        } else if (isMovingAnchor) {
          // Move anchor only
          const anchorImageSpace = fromScreenCoords(mx, my);
          imageState.anchorX = anchorImageSpace.x;
          imageState.anchorY = anchorImageSpace.y;
        } else if (isRotating) {
          // Rotate around anchor
          const a = toScreenCoords(imageState.anchorX, imageState.anchorY);
          const angle1 = Math.atan2(lastMouse.y - a.y, lastMouse.x - a.x);
          const angle2 = Math.atan2(my - a.y, mx - a.x);
          const delta = angle2 - angle1;
          const cos = Math.cos(delta);
          const sin = Math.sin(delta);
          const dxp = imageState.x - a.x;
          const dyp = imageState.y - a.y;
          const newX = a.x + dxp * cos - dyp * sin;
          const newY = a.y + dxp * sin + dyp * cos;
          imageState.x = newX;
          imageState.y = newY;
          imageState.angle += delta;
        }

        lastMouse = { x: mx, y: my };
        draw();
      });

      // Scale around anchor
      canvas.addEventListener("wheel", (e) => {
        if (!img) return;
        e.preventDefault();
        const scaleFactor = e.deltaY < 0 ? 1.05 : 0.95;
        const anchor = toScreenCoords(imageState.anchorX, imageState.anchorY);
        imageState.x =
          anchor.x + (imageState.x - anchor.x) * scaleFactor;
        imageState.y =
          anchor.y + (imageState.y - anchor.y) * scaleFactor;
        imageState.scale *= scaleFactor;
        draw();
      });
      
      // Keyboard Events
      window.addEventListener("keydown", (e) => {
        if (e.key.toLowerCase() === "r") {
          isRotating = true;
        }
      });
      window.addEventListener("keyup", (e) => {
        if (e.key.toLowerCase() === "r") {
          isRotating = false;
        }
      });
      window.addEventListener("keydown", (e) => {
        if (e.code === "Space") {
          imageState.anchorX = 0;
          imageState.anchorY = 0;
          draw();
        }
      });
    </script>
  </body>
</html>
